<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Miniverse</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
body { margin:0; font-family:Arial; background:#1b1b1b; color:white; }
#loginScreen, #menuScreen, #gameScreen { display:none; }
#loginScreen { text-align:center; margin-top:120px; }
input { padding:10px; margin:5px; width:200px; }
button { padding:8px 15px; cursor:pointer; border:none; background:#2e2e2e; color:white; border-radius:6px; }
button:hover { background:#3a3a3a; }

/* Menu */
#menuTop { display:flex; justify-content: space-between; align-items:center; padding:20px 40px; }
#welcomeContainer { display:flex; align-items:center; gap:15px; font-size:20px; }
#profileAvatar { width:50px; height:50px; }
#menuButtons button { margin-left:10px; }
#menuGrid { display:flex; flex-wrap:wrap; gap:20px; padding:0 40px 40px 40px; }
.gameCard { background:#2a2a2a; width:220px; height:140px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:bold; cursor:pointer; transition:0.2s; }
.gameCard:hover { background:#3c3c3c; transform:scale(1.05); }

/* Avatar menu */
#avatarOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:100; }
#avatarPanel { background:#242424; width:500px; border-radius:12px; padding:20px; }
#avatarGrid { display:grid; grid-template-columns:repeat(4,1fr); gap:15px; }
.avatarOption { width:80px; height:90px; cursor:pointer; border:3px solid transparent; }
.selectedAvatar { border:3px solid #00b3ff; }

/* Canvas & Chat */
canvas { display:block; }
#chatBox { position:absolute; bottom:0; left:0; width:300px; height:250px; background:rgba(0,0,0,0.75); display:flex; flex-direction:column; }
#messages { flex:1; overflow-y:auto; padding:5px; font-size:14px; }
#chatInput { border:none; padding:5px; }
#onlineCount { position:absolute; top:10px; left:10px; color:white; font-weight:bold; }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
<h2>Miniverse</h2>
<input id="username" placeholder="Username"><br>
<input id="password" type="password" placeholder="Password"><br>
<button onclick="signup()">Sign Up</button>
<button onclick="login()">Login</button>
<p id="error" style="color:red;"></p>
</div>

<!-- MAIN MENU -->
<div id="menuScreen">
<div id="menuTop">
  <div id="welcomeContainer">
    <canvas id="profileAvatar" width="50" height="50"></canvas>
    <span id="welcomeText"></span>
  </div>
  <div id="menuButtons">
    <button onclick="openAvatarMenu()">Avatar</button>
    <button onclick="signOut()">Sign Out</button>
  </div>
</div>
<div id="menuGrid">
  <div class="gameCard" onclick="openGame('sandbox')">Sandbox Builder</div>
  <div class="gameCard" onclick="openGame('military')">Military Fights</div>
</div>
</div>

<!-- AVATAR MENU -->
<div id="avatarOverlay">
  <div id="avatarPanel">
    <h3>Customize Avatar</h3>
    <div id="avatarGrid"></div>
    <br>
    <button onclick="closeAvatarMenu()">Close</button>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen">
<button onclick="exitGame()" style="position:absolute;top:10px;right:10px;">Back</button>
<div id="onlineCount"></div>
<div id="chatBox">
  <div id="messages"></div>
  <input id="chatInput" placeholder="Type message...">
</div>
<canvas id="gameCanvas"></canvas>
</div>

<script>
// FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyCwBRue2zavMdVKdOhdVYdG66aWvjC-PC4",
  authDomain: "miniverse-d1dc8.firebaseapp.com",
  databaseURL: "https://miniverse-d1dc8-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "miniverse-d1dc8",
  storageBucket: "miniverse-d1dc8.firebasestorage.app",
  messagingSenderId: "233990615052",
  appId: "1:233990615052:web:6da79cc10b0b217495fe29"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// AVATARS (face + shirt)
const avatars=[
  {skin:"#f1c27d",shirt:"#3b82f6",eyes:"#000"},
  {skin:"#f1c27d",shirt:"#ef4444",eyes:"#000"},
  {skin:"#bbbbbb",shirt:"#555",eyes:"#00ffff"},
  {skin:"#7fbf7f",shirt:"#3d6b3d",eyes:"#000"}
];
let currentAvatar=0;

// DRAW FACE FUNCTION
function drawFace(ctx,x,y,size,av){
  const px=size/16;
  ctx.fillStyle=av.skin; ctx.fillRect(x,y,size,size);
  ctx.fillStyle=av.eyes; ctx.fillRect(x+4*px,y+5*px,2*px,2*px);
  ctx.fillRect(x+10*px,y+5*px,2*px,2*px);
  ctx.fillStyle="#000"; ctx.fillRect(x+6*px,y+11*px,4*px,1*px);
  ctx.fillStyle=av.shirt; ctx.fillRect(x,y+size,size,1);
}

// AVATAR MENU
const avatarGrid=document.getElementById("avatarGrid");
avatars.forEach((a,i)=>{
  const c=document.createElement("canvas"); c.width=80; c.height=90; c.className="avatarOption";
  const ctx=c.getContext("2d"); drawFace(ctx,10,10,60,a);
  c.onclick=()=>{ currentAvatar=i; db.ref("players/"+auth.currentUser.uid).update({avatar:i}); updateAvatarDisplay(); highlightSelected(); };
  avatarGrid.appendChild(c);
});
function highlightSelected(){ document.querySelectorAll(".avatarOption").forEach((el,i)=>{ el.classList.remove("selectedAvatar"); if(i===currentAvatar)el.classList.add("selectedAvatar"); }); }
function openAvatarMenu(){ avatarOverlay.style.display="flex"; highlightSelected(); }
function closeAvatarMenu(){ avatarOverlay.style.display="none"; }
function updateAvatarDisplay(){ let c=document.getElementById("profileAvatar"); let ctx=c.getContext("2d"); ctx.clearRect(0,0,50,50); drawFace(ctx,5,5,40,avatars[currentAvatar]); }

// AUTH
auth.onAuthStateChanged(user=>{
  if(user){
    loginScreen.style.display="none";
    menuScreen.style.display="block";
    let name=user.email.split("@")[0]; welcomeText.innerText="Welcome "+name;
    db.ref("players/"+user.uid+"/avatar").once("value").then(s=>{ if(s.exists())currentAvatar=s.val(); updateAvatarDisplay(); });
  }else{ loginScreen.style.display="block"; menuScreen.style.display="none"; }
});
function signup(){ auth.createUserWithEmailAndPassword(username.value.toLowerCase()+"@miniverse.com",password.value).catch(e=>error.innerText=e.message); }
function login(){ auth.signInWithEmailAndPassword(username.value.toLowerCase()+"@miniverse.com",password.value).catch(e=>error.innerText=e.message); }
function signOut(){ auth.signOut(); }

// GAME MANAGEMENT
let currentGame="";
function openGame(name){ currentGame=name; menuScreen.style.display="none"; gameScreen.style.display="block"; startGame(); }
function exitGame(){ gameScreen.style.display="none"; menuScreen.style.display="block"; }

// START GAME
function startGame(){
  const canvas=document.getElementById("gameCanvas"); const ctx=canvas.getContext("2d");
  canvas.width=window.innerWidth; canvas.height=window.innerHeight;
  const user=auth.currentUser; const username=user.email.split("@")[0];
  const playersRef=db.ref("players"); const blocksRef=db.ref("blocks"); const chatRef=db.ref("chat");
  playersRef.child(user.uid).set({x:200,y:200,username,avatar:currentAvatar}); playersRef.child(user.uid).onDisconnect().remove();
  let players={}, blocks={}, keys={}, bullets=[], bots=[]; const TILE=40;

  // CHAT
  chatRef.limitToLast(50).on("child_added",snap=>{ const m=snap.val(); const div=document.createElement("div"); div.innerText=m.username+": "+m.text; messages.appendChild(div); messages.scrollTop=messages.scrollHeight; });
  document.getElementById("chatInput").onkeydown=e=>{
    if(e.key==="Enter"){ let text=e.target.value.trim(); if(!text) return; e.target.value="";
      ["fuck","shit","bitch","asshole","retard"].forEach(w=>{ const r=new RegExp("\\b"+w+"\\b","gi"); text=text.replace(r,"***"); });
      chatRef.push({username,text}); 
    }
  };

  // KEYBOARD
  document.addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
  document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

  // INIT
  playersRef.on("value",s=>{ players=s.val()||{}; onlineCount.innerText="Online: "+Object.keys(players).length; });
  if(currentGame==="sandbox"){ blocksRef.on("value",s=>blocks=s.val()||{}); }
  if(currentGame==="military"){ // INIT BOTS
    for(let i=0;i<5;i++) bots.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, vx:Math.random()*2-1, vy:Math.random()*2-1});
  }

  canvas.onclick=e=>{
    if(currentGame==="sandbox"){
      const r=canvas.getBoundingClientRect();
      const x=Math.floor((e.clientX-r.left)/TILE);
      const y=Math.floor((e.clientY-r.top)/TILE);
      const key = x+"_"+y;
      if(blocks[key]) blocksRef.child(key).remove(); else blocksRef.child(key).set({x,y});
    }
    if(currentGame==="military"){
      bullets.push({x:players[user.uid].x+15, y:players[user.uid].y+15, vx:(e.clientX-players[user.uid].x-15)/20, vy:(e.clientY-players[user.uid].y-15)/20, owner:user.uid});
    }
  };

  // LOOP
  function loop(){
    // UPDATE
    if(players[user.uid]){
      let p=players[user.uid]; let nx=p.x, ny=p.y;
      if(keys["w"])ny-=3; if(keys["s"])ny+=3; if(keys["a"])nx-=3; if(keys["d"])nx+=3;
      playersRef.child(user.uid).update({x:nx,y:ny});
    }

    if(currentGame==="military"){
      bullets.forEach(b=>{ b.x+=b.vx; b.y+=b.vy; });
      bots.forEach(bot=>{
        bot.x+=bot.vx; bot.y+=bot.vy;
        if(bot.x<0||bot.x>canvas.width) bot.vx*=-1;
        if(bot.y<0||bot.y>canvas.height) bot.vy*=-1;
      });
    }

    // DRAW
    ctx.fillStyle=currentGame==="sandbox"?"#4aa3ff":"#3a3a3a"; ctx.fillRect(0,0,canvas.width,canvas.height);
    if(currentGame==="sandbox"){ // BLOCKS
      ctx.fillStyle="#8B5A2B"; for(let b in blocks){ let bl=blocks[b]; ctx.fillRect(bl.x*TILE,bl.y*TILE,TILE,TILE); } 
    }
    // PLAYERS
    for(let id in players){
      let p=players[id]; drawFace(ctx,p.x,p.y,30,avatars[p.avatar||0]);
      ctx.fillStyle="white"; ctx.textAlign="center"; ctx.fillText(p.username,p.x+15,p.y-5);
    }
    if(currentGame==="military"){ // BOTS
      ctx.fillStyle="red"; bots.forEach(bot=>drawFace(ctx,bot.x,bot.y,30,avatars[0]));
      ctx.fillStyle="yellow"; bullets.forEach(b=>ctx.fillRect(b.x,b.y,5,5));
    }

    requestAnimationFrame(loop);
  }
  loop();
}
</script>
</body>
</html>